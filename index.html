<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- Web App Einstellungen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-title" content="Haywire Finder">
    <meta name="application-name" content="Haywire Finder">
    
    <!-- Link zum externen Manifest (WICHTIG für Installation) -->
    <link rel="manifest" href="./manifest.json">

    <title>Haywire Finder</title>
    
    <!-- Design & Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Google Fonts: Roboto -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        html, body {
            background-color: #0f172a; 
            font-family: 'Roboto', sans-serif; 
            overscroll-behavior-y: none;
            height: 100%;
            overflow-x: hidden;
        }
        
        .font-brand {
            font-family: 'Roboto', sans-serif;
            letter-spacing: normal;
        }

        .grid-transition {
            transition: all 0.3s ease-in-out;
        }

        .fluid-header {
            font-size: clamp(0.95rem, 3.8vw, 1.6rem);
            line-height: 1.1;
        }

        .fluid-subtitle {
            font-size: clamp(0.55rem, 1.4vw, 0.65rem);
            line-height: 1.2;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ICONS ---
        const Icons = {
            Search: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            ),
            X: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            ),
            ArrowLeft: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
            ),
            Download: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            )
        };

        const Icon = ({ name, size = 24, className = "" }) => {
            const IconComponent = Icons[name];
            return IconComponent ? <IconComponent width={size} height={size} className={className} /> : null;
        };

        // --- MOCK DATA ---
        const MOCK_DATA = [
            { id: 1, CHANNEL: "1", TYP: "Viper Performance", POSITION: "Z-Brücke 1", ORT: "Dimmerraum 3", ADRESSE: "10/337", ROW: "7" }
        ];

        function App() {
            const [fixtures, setFixtures] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [activeFilter, setActiveFilter] = useState("Alle");
            const [activeRowFilter, setActiveRowFilter] = useState(null);
            const [status, setStatus] = useState("Lade...");
            const [showAllForced, setShowAllForced] = useState(false);
            
            // PWA Install State
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [isInstallable, setIsInstallable] = useState(false);

            useEffect(() => {
                // Event Listener für Installations-Prompt
                const handleBeforeInstallPrompt = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                    setIsInstallable(true);
                };

                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);

                return () => {
                    window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                };
            }, []);

            const handleInstallClick = async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    setIsInstallable(false);
                }
                setDeferredPrompt(null);
            };

            const filterRows = [
                [{l:"Z-B 1",v:"Z-Brücke 1",c:"text-cyan-500"}, {l:"1FS B",v:"Z-Brücke 3",c:"text-cyan-500"}, {l:"Stage",v:"DS Trough",c:"text-cyan-500"}, {l:"Portal",v:"Portal",c:"text-cyan-500"}],
                [{l:"ST SR",v:"Sound Truss SR",c:"text-rose-500"}, {l:"ST SRC",v:"Sound Truss SRC",c:"text-rose-500"}, {l:"ST SLC",v:"Sound Truss SLC",c:"text-rose-500"}, {l:"ST SL",v:"Sound Truss SL",c:"text-rose-500"}],
                [{l:"NBB SR",v:"Near Box Boom SR",c:"text-blue-500"}, {l:"PB SR",v:"Prosc Boom SR",c:"text-blue-500"}, {l:"AT SR",v:"Advanced Truss SR",c:"text-blue-500"}],
                [{l:"NBB SL",v:"Near Box Boom SL",c:"text-blue-500"}, {l:"PB SL",v:"Prosc Boom SL",c:"text-blue-500"}, {l:"AT SL",v:"Advanced Truss SL",c:"text-blue-500"}, {l:"LX 4a",v:"LX 4a",c:"text-yellow-700"}],
                [{l:"LX 1",v:"LX 1",c:"text-yellow-500"}, {l:"LX 2",v:"LX 2",c:"text-yellow-500"}, {l:"LX 3",v:"LX 3",c:"text-yellow-500"}, {l:"LX 4",v:"LX 4",c:"text-yellow-500"}, {l:"LX 5",v:"LX 5",c:"text-yellow-500"}],
                [{l:"L1 SR",v:"Leiter 1 SR",c:"text-emerald-500"}, {l:"L2 SR",v:"Leiter 2 SR",c:"text-emerald-500"}, {l:"L3 SR",v:"Leiter 3 SR",c:"text-emerald-500"}, {l:"L4 SR",v:"Leiter 4 SR",c:"text-emerald-500"}],
                [{l:"B1 SR",v:"Boom 1 SR",c:"text-violet-500"}, {l:"B2 SR",v:"Boom 2 SR",c:"text-violet-500"}, {l:"B3 SR",v:"Boom 3 SR",c:"text-violet-500"}, {l:"B4 SR",v:"Boom 4 SR",c:"text-violet-500"}],
                [{l:"L1 SL",v:"Leiter 1 SL",c:"text-emerald-500"}, {l:"L2 SL",v:"Leiter 2 SL",c:"text-emerald-500"}, {l:"L3 SL",v:"Leiter 3 SL",c:"text-emerald-500"}, {l:"L4 SL",v:"Leiter 4 SL",c:"text-emerald-500"}],
                [{l:"B1 SL",v:"Boom 1 SL",c:"text-violet-500"}, {l:"B2 SL",v:"Boom 2 SL",c:"text-violet-500"}, {l:"B3 SL",v:"Boom 3 SL",c:"text-violet-500"}, {l:"B4 SL",v:"Boom 4 SL",c:"text-violet-500"}]
            ];

            const rowColorClasses = ["text-blue-300", "text-emerald-300", "text-violet-300", "text-amber-300", "text-rose-300", "text-cyan-300"];
            const hardcodedValues = useMemo(() => filterRows.flat().map(item => item.v), []);

            useEffect(() => {
                const loadData = async () => {
                    try {
                        const response = await fetch("fixtures.csv").catch(() => null);
                        if (response && response.ok) {
                            const csvText = await response.text();
                            window.Papa.parse(csvText, {
                                header: true,
                                skipEmptyLines: true,
                                complete: (results) => {
                                    if (results.data && results.data.length > 0) {
                                        const parsed = results.data.map((row, i) => ({
                                            id: Date.now() + i,
                                            CHANNEL: row.CHANNEL || row.Channel || "---",
                                            TYP: row.TYP || row.Typ || "Unbekannt",
                                            POSITION: row.POSITION || row.Position || "Unbekannt",
                                            ORT: row.ORT || row.Ort || "",
                                            ADRESSE: row.ADRESSE || row.Adresse || "---",
                                            ROW: row.ROW || row.Row || ""
                                        }));
                                        setFixtures(parsed);
                                        setStatus("");
                                    } else {
                                        setFixtures(MOCK_DATA);
                                        setStatus("Demo-Modus");
                                    }
                                }
                            });
                        } else {
                            setFixtures(MOCK_DATA);
                            setStatus("Demo-Modus");
                        }
                    } catch (e) {
                        setFixtures(MOCK_DATA);
                        setStatus("Demo-Modus");
                    }
                };
                loadData();
            }, []);

            const isInteractionActive = useMemo(() => searchTerm.trim() !== "" || activeFilter !== "Alle" || showAllForced, [searchTerm, activeFilter, showAllForced]);

            const availableRows = useMemo(() => {
                if (activeFilter === "Alle") return [];
                const rows = new Set();
                fixtures.forEach(f => {
                    if (f.POSITION === activeFilter && f.ROW) {
                        const r = parseInt(f.ROW, 10);
                        if (!isNaN(r)) rows.add(r);
                    }
                });
                return Array.from(rows).sort((a, b) => a - b);
            }, [fixtures, activeFilter]);

            const filteredFixtures = useMemo(() => {
                if (!isInteractionActive) return [];
                const search = searchTerm.trim().toLowerCase();
                const isNumericSearch = search !== "" && /^\d+$/.test(search);
                return fixtures.filter(f => {
                    const fixtureChannel = f.CHANNEL.toString().toLowerCase().trim();
                    const fixtureType = f.TYP.toLowerCase();
                    let matchesSearch = isNumericSearch ? fixtureChannel === search : (fixtureChannel.includes(search) || fixtureType.includes(search));
                    const matchesFilter = activeFilter === "Alle" || f.POSITION === activeFilter;
                    let matchesRow = true;
                    if (activeFilter !== "Alle" && activeRowFilter !== null) {
                        matchesRow = f.ROW === activeRowFilter.toString();
                    }
                    return matchesSearch && matchesFilter && matchesRow;
                });
            }, [fixtures, searchTerm, activeFilter, activeRowFilter, isInteractionActive]);

            const otherPositions = useMemo(() => {
                const hardcodedValues = filterRows.flat().map(item => item.v);
                const allPos = new Set(fixtures.map(f => f.POSITION));
                return Array.from(allPos).filter(p => p && p !== "Unbekannt" && !hardcodedValues.includes(p)).sort();
            }, [fixtures, filterRows]);

            const toggleFilter = (val) => {
                if (activeFilter === val) { setActiveFilter("Alle"); setShowAllForced(false); } 
                else { setActiveFilter(val); setShowAllForced(false); }
                setActiveRowFilter(null);
            };

            const toggleRowFilter = (rowNum) => {
                setActiveRowFilter(activeRowFilter === rowNum ? null : rowNum);
            };

            const handleToggleAll = () => {
                if (showAllForced && activeFilter === "Alle" && searchTerm === "") setShowAllForced(false);
                else { setSearchTerm(""); setActiveFilter("Alle"); setShowAllForced(true); setActiveRowFilter(null); }
            };

            const activeFilterData = useMemo(() => {
                if (activeFilter === "Alle") return null;
                const found = filterRows.flat().find(it => it.v === activeFilter);
                if (found) return found;
                return { l: activeFilter, v: activeFilter, c: "text-slate-400" };
            }, [activeFilter, filterRows]);

            const FilterBtn = ({ label, value, colorClass = "text-slate-400" }) => (
                <button onClick={() => toggleFilter(value)} className={`min-w-[60px] px-2 py-1 rounded-lg text-xs font-normal transition-all border font-brand whitespace-nowrap flex items-center justify-center ${activeFilter === value ? 'bg-blue-600 border-blue-500 text-white shadow-lg scale-105' : `bg-slate-800 border-slate-700 ${colorClass} hover:bg-slate-700 hover:border-slate-500 hover:text-white`}`}>{label}</button>
            );

            return (
                <div className="min-h-screen bg-gradient-to-b from-slate-900 to-slate-950 text-slate-200 font-brand pb-40">
                    <div className="sticky top-0 z-20 bg-slate-900/95 border-b border-slate-800 shadow-xl backdrop-blur-md px-4 py-4 md:py-6">
                        <div className="max-w-7xl mx-auto space-y-4">
                            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div className="flex flex-col">
                                    <div className="flex justify-between items-start">
                                        <h1 className="fluid-header font-normal text-[#b3b3b3] font-brand truncate uppercase tracking-tight">HAYWIRE &nbsp; FINDER</h1>
                                        {/* Install Button (Nur sichtbar wenn installierbar) */}
                                        {isInstallable && (
                                            <button onClick={handleInstallClick} className="md:hidden bg-blue-600/20 border border-blue-500/50 text-blue-400 px-2 py-1 rounded text-[10px] uppercase font-bold tracking-wider hover:bg-blue-600 hover:text-white transition-colors flex items-center gap-1">
                                                <Icon name="Download" size={12} /> App Installieren
                                            </button>
                                        )}
                                    </div>
                                    <div className="fluid-subtitle font-normal text-[#b3b3b3] font-brand uppercase tracking-widest opacity-90 mt-0.5">Moving Head Finder MJ Musical</div>
                                </div>
                                <div className="flex items-center gap-2 w-full md:max-w-xs">
                                    <div className="relative w-full">
                                        <input className="w-full bg-slate-800 p-3 pl-10 rounded-lg border border-slate-700 text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder-slate-500 font-brand" placeholder="Suche Channel oder Typ..." value={searchTerm} onChange={e => { setSearchTerm(e.target.value); if (e.target.value.trim() !== "") setShowAllForced(false); }} />
                                        <div className="absolute left-3 top-3.5 text-slate-500"><Icon name="Search" size={18} /></div>
                                        {searchTerm && <button onClick={() => setSearchTerm("")} className="absolute right-3 top-3.5 text-slate-500 hover:text-white"><Icon name="X" size={18} /></button>}
                                    </div>
                                    {isInstallable && (
                                        <button onClick={handleInstallClick} className="hidden md:flex bg-blue-600/20 border border-blue-500/50 text-blue-400 p-3 rounded-lg hover:bg-blue-600 hover:text-white transition-colors" title="Als App installieren">
                                            <Icon name="Download" size={20} />
                                        </button>
                                    )}
                                </div>
                            </div>
                            <div className="space-y-3 pt-2">
                                {activeFilter === "Alle" ? (
                                    <>
                                        <div className="flex justify-start">
                                            <button onClick={handleToggleAll} className={`min-w-[60px] px-4 py-1 rounded-lg text-xs font-medium transition-all border font-brand ${showAllForced && activeFilter === "Alle" && searchTerm === "" ? 'bg-blue-600 border-blue-500 text-white shadow-lg scale-105' : 'bg-slate-800 border-slate-700 text-slate-300 hover:bg-slate-700 hover:border-slate-500'}`}>Alle</button>
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            {filterRows.map((row, idx) => (
                                                <div key={idx} className="flex gap-2 overflow-x-auto scrollbar-hide py-0.5">
                                                    {row.map(item => <FilterBtn key={item.v} label={item.l} value={item.v} colorClass={item.c} />)}
                                                </div>
                                            ))}
                                            {otherPositions.length > 0 && (
                                                <div className="flex gap-2 overflow-x-auto scrollbar-hide border-t border-slate-800 pt-2 mt-1">
                                                    {otherPositions.map(p => <FilterBtn key={p} label={p} value={p} colorClass="text-slate-400" />)}
                                                </div>
                                            )}
                                        </div>
                                    </>
                                ) : (
                                    <div className="flex flex-col gap-2">
                                        <div className="flex justify-between items-center pb-2">
                                            <button onClick={() => toggleFilter("Alle")} className="flex items-center gap-1.5 pl-1 pr-3 py-1.5 text-xs font-medium text-slate-400 hover:text-white transition-colors">
                                                <Icon name="ArrowLeft" size={16} /> Zurück
                                            </button>
                                            {activeFilterData && (
                                                <FilterBtn label={activeFilterData.l} value={activeFilterData.v} colorClass={activeFilterData.c} />
                                            )}
                                        </div>
                                        
                                        {availableRows.length > 0 && (
                                            <>
                                                <div className="text-xs text-slate-400 font-normal px-1 pb-1">Wievielte Lampe von links bzw. unten ?</div>
                                                <div className="flex gap-2 overflow-x-auto scrollbar-hide py-1 border-t border-slate-800/50">
                                                    {availableRows.map(num => (
                                                        <button 
                                                            key={num}
                                                            onClick={() => toggleRowFilter(num)}
                                                            className={`w-8 h-8 rounded-full text-xs font-bold flex items-center justify-center transition-all border shrink-0 ${
                                                                activeRowFilter === num
                                                                ? 'bg-emerald-600 border-emerald-500 text-white shadow-lg scale-110'
                                                                : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700 hover:text-white'
                                                            }`}
                                                        >
                                                            {num}
                                                        </button>
                                                    ))}
                                                </div>
                                            </>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    
                    <div className="p-4 md:p-8 max-w-7xl mx-auto">
                        {status && <div className="text-center py-4 text-xs text-yellow-600 mb-4 animate-pulse">{status}</div>}
                        {!isInteractionActive ? (
                            <div className="text-center p-20 text-slate-500 flex flex-col items-center gap-4 animate-in fade-in duration-700"></div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6 grid-transition">
                                {filteredFixtures.map(fixture => {
                                    const parts = fixture.ADRESSE.split('/');
                                    const universe = parts[0];
                                    const rest = parts.length > 1 ? `/${parts.slice(1).join('.')}` : '';
                                    return (
                                        <div key={fixture.id} className="bg-slate-800/80 backdrop-blur-sm p-3.5 rounded-2xl border border-slate-700 shadow-md hover:shadow-xl hover:border-slate-500 transition-all duration-300 relative group flex flex-col justify-between min-h-[112px]">
                                            <div className="space-y-2 font-brand">
                                                <div className="flex items-center gap-3">
                                                    <span className="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-bold shadow-sm group-hover:bg-blue-500 transition-colors shrink-0">{fixture.CHANNEL}</span>
                                                    <h3 className="font-medium text-white text-base md:text-lg leading-tight truncate group-hover:text-blue-200 transition-colors">{fixture.TYP}</h3>
                                                </div>
                                                {fixture.ORT && <div className="flex justify-start"><div className="text-base font-bold text-emerald-400 truncate text-left max-w-full">{fixture.ORT}</div></div>}
                                            </div>
                                            <div className="mt-3 flex justify-between items-end gap-1">
                                                <div className="flex flex-col max-w-[65%]">
                                                    <div className="text-xs font-normal text-slate-300 truncate">{fixture.POSITION}</div>
                                                    {fixture.ROW && <div className="text-[9px] font-medium text-slate-500 uppercase tracking-tighter leading-tight mt-0.5 flex items-baseline">Fixture von links / unten:&nbsp;&nbsp;&nbsp;&nbsp;<span className="text-base font-bold text-slate-200">{fixture.ROW}</span></div>}
                                                </div>
                                                <div className="text-xs font-brand font-normal text-slate-300 tracking-tighter shrink-0 pb-1">DMX: <span className="font-bold">{universe}</span><span className="font-bold">{rest}</span></div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                        {isInteractionActive && filteredFixtures.length === 0 && (
                            <div className="text-center p-20 text-slate-500 flex flex-col items-center gap-4">
                                <div className="p-4 bg-slate-800 rounded-full"><Icon name="Search" size={40} className="text-slate-600" /></div>
                                <p className="text-lg">Keine Lampen für deine Auswahl gefunden.</p>
                                <button onClick={() => {setSearchTerm(""); setActiveFilter("Alle"); setShowAllForced(false);}} className="text-blue-500 hover:underline">Filter zurücksetzen</button>
                            </div>
                        )}
                    </div>
                    <div className="fixed bottom-0 left-0 right-0 bg-slate-900/80 backdrop-blur-md border-t border-slate-800 p-4 text-center z-30 font-brand">
                        <div className="max-w-7xl mx-auto flex justify-between items-center text-[10px] text-slate-600 uppercase tracking-widest font-brand">
                            <span>{isInteractionActive ? filteredFixtures.length : 0} Geräte gefunden</span>
                            <span className="hidden sm:inline">HAYWIRE FINDER &nbsp;&nbsp; V &nbsp; 1 . 2</span>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <!-- Externer Service Worker Registrierung -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((reg) => console.log('Service Worker registriert: ', reg.scope))
                    .catch((err) => console.log('Service Worker Fehler: ', err));
            });
        }
    </script>
</body>
</html>
