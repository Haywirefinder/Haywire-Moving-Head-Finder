<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haywire Moving Head Finder</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { background-color: #0f172a; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- INTERNE ICONS (Ersetzt die externe Bibliothek, die den Absturz verursacht) ---
        // Wir definieren die SVGs hier direkt. Das ist 100% sicher und stürzt nie ab.
        const Icons = {
            Aperture: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m14.31 8 5.74 9.94"/><path d="M9.69 8h11.48"/><path d="m7.38 12 5.74-9.94"/><path d="M9.69 16 3.95 6.06"/><path d="M14.31 16H2.83"/><path d="m16.62 12-5.74 9.94"/></svg>
            ),
            Search: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            ),
            Edit2: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
            ),
            MapPin: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
            ),
            X: (props) => (
                <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            )
        };

        // Hilfskomponente für Icons
        const Icon = ({ name, size = 24, className = "" }) => {
            const IconComponent = Icons[name];
            if (!IconComponent) return null;
            return <IconComponent width={size} height={size} className={className} />;
        };

        // --- HAUPT PROGRAMM ---

        function App() {
            const [fixtures, setFixtures] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [activeFilter, setActiveFilter] = useState("Alle");
            const [status, setStatus] = useState("Lade Daten...");
            const [editId, setEditId] = useState(null); // Für später vorbereitet

            // CSV Laden
            useEffect(() => {
                const saved = localStorage.getItem('fixtureData');
                // Wenn lokale Daten da sind, zeigen wir sie sofort an
                if (saved) {
                    try {
                        setFixtures(JSON.parse(saved));
                        setStatus(""); 
                    } catch (e) {
                        console.error("Datenfehler", e);
                    }
                }

                // Versuche immer die frische CSV zu laden
                if (window.Papa) {
                    window.Papa.parse("fixtures.csv", {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.data && results.data.length > 0) {
                                const parsed = results.data.map((row, i) => ({
                                    id: Date.now() + i, // Einmalige ID generieren
                                    CHANNEL: row.CHANNEL || row.Channel || "---",
                                    TYP: row.TYP || row.Typ || "Unbekannt",
                                    POSITION: row.POSITION || row.Position || "Unbekannt",
                                    ORT: row.ORT || row.Ort || ""
                                }));
                                setFixtures(parsed);
                                setStatus("");
                            } else if (!saved) {
                                setStatus("CSV geladen, aber leer.");
                            }
                        },
                        error: (err) => {
                            if (!saved) setStatus("Keine 'fixtures.csv' gefunden.");
                            console.warn("CSV Ladefehler:", err);
                        }
                    });
                }
            }, []);

            // Speichern (optional für später)
            useEffect(() => {
                if (fixtures.length > 0) localStorage.setItem('fixtureData', JSON.stringify(fixtures));
            }, [fixtures]);

            // Filter Logik
            const availablePositions = useMemo(() => {
                const positions = new Set(fixtures.map(f => f.POSITION));
                // Entferne leere Positionen und sortiere
                const sorted = Array.from(positions).filter(p => p && p !== "Unbekannt").sort();
                return ["Alle", ...sorted];
            }, [fixtures]);

            const filteredFixtures = useMemo(() => {
                return fixtures.filter(f => {
                    const search = searchTerm.toLowerCase();
                    const matchesSearch = f.CHANNEL.toLowerCase().includes(search) || f.TYP.toLowerCase().includes(search);
                    const matchesFilter = activeFilter === "Alle" || f.POSITION === activeFilter;
                    return matchesSearch && matchesFilter;
                });
            }, [fixtures, searchTerm, activeFilter]);

            return (
                <div className="min-h-screen bg-slate-900 text-slate-200 font-sans pb-20">
                    {/* Header */}
                    <div className="sticky top-0 z-20 bg-slate-900/95 p-4 border-b border-slate-800 shadow-xl backdrop-blur-sm">
                        <div className="max-w-md mx-auto space-y-4">
                            <h1 className="text-xl font-bold text-white flex items-center gap-2">
                                <Icon name="Aperture" className="text-yellow-500" /> Haywire Finder
                            </h1>
                            
                            <div className="relative">
                                <input 
                                    className="w-full bg-slate-800 p-3 pl-10 rounded-lg border border-slate-700 text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" 
                                    placeholder="Channel (z.B. 101) oder Typ..." 
                                    value={searchTerm}
                                    onChange={e => setSearchTerm(e.target.value)} 
                                />
                                <div className="absolute left-3 top-3.5 text-slate-500">
                                    <Icon name="Search" size={18} />
                                </div>
                                {searchTerm && (
                                    <button onClick={() => setSearchTerm("")} className="absolute right-3 top-3.5 text-slate-500 hover:text-white">
                                        <Icon name="X" size={18} />
                                    </button>
                                )}
                            </div>

                            <div className="flex gap-2 overflow-x-auto scrollbar-hide pb-1 -mx-4 px-4 sm:mx-0 sm:px-0">
                                {availablePositions.map(pos => (
                                    <button 
                                        key={pos} 
                                        onClick={() => setActiveFilter(pos)} 
                                        className={`px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors border ${
                                            activeFilter === pos 
                                            ? 'bg-blue-600 border-blue-500 text-white shadow-lg shadow-blue-900/50' 
                                            : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700 hover:text-white'
                                        }`}
                                    >
                                        {pos}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="p-4 max-w-md mx-auto">
                        {status && (
                            <div className="text-center py-10 px-4">
                                <p className="text-slate-500 mb-2">{status}</p>
                                {/* Falls keine Daten da sind, zeige einen Dummy-Eintrag als Beispiel */}
                                {fixtures.length === 0 && (
                                    <div className="text-xs text-slate-600 bg-slate-800/50 p-2 rounded">
                                        Tipp: Lade eine 'fixtures.csv' in dein GitHub Repository hoch.
                                    </div>
                                )}
                            </div>
                        )}
                        
                        <div className="grid gap-3">
                            {filteredFixtures.map(fixture => (
                                <div key={fixture.id} className="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-sm hover:border-slate-600 transition-colors">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="bg-blue-600 text-white px-2 py-0.5 rounded text-sm font-bold font-mono">
                                                    #{fixture.CHANNEL}
                                                </span>
                                            </div>
                                            <h3 className="font-bold text-white text-lg leading-tight">{fixture.TYP}</h3>
                                            <div className="flex items-center gap-4 mt-2">
                                                <p className="text-xs font-medium text-slate-400 flex items-center gap-1 bg-slate-900/50 px-2 py-1 rounded">
                                                    <Icon name="MapPin" size={12} className="text-slate-500" /> 
                                                    {fixture.POSITION}
                                                </p>
                                                {fixture.ORT && (
                                                    <p className="text-xs text-slate-500">
                                                        {fixture.ORT}
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                        {/* Edit Button (vorbereitet) */}
                                        <button className="text-slate-600 hover:text-blue-400 p-2 rounded-full hover:bg-slate-700 transition-colors">
                                            <Icon name="Edit2" size={18} />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        {filteredFixtures.length === 0 && !status && (
                            <div className="text-center p-10 text-slate-500">
                                Keine Lampen gefunden für "{searchTerm}"
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
